<!-- MASTER CART CONFIGURATION & DESIGN v1 -->
<!-- ЧАСТЬ 1: КОНФИГУРАЦИЯ + СТИЛИ + UPSELL -->

<style>
    /* === 1. NOVA GLASS DESIGN SYSTEM (СТИЛИ КОРЗИНЫ) === */

    /* Backdrop & Window */
    .t706__cartwin {
        background-color: rgba(0, 0, 0, 0.3) !important;
        backdrop-filter: blur(6px);
    }

    .t706__cartwin-content {
        background-color: rgba(255, 255, 255, 0.9) !important;
        backdrop-filter: blur(25px) !important;
        -webkit-backdrop-filter: blur(25px) !important;
        border-left: 1px solid rgba(255, 255, 255, 0.5);
        box-shadow: -10px 0 50px rgba(0, 0, 0, 0.15) !important;
    }

    /* Layout (Desktop) */
    @media screen and (min-width: 960px) {
        .t706__cartwin-content {
            border-top-left-radius: 30px;
            border-bottom-left-radius: 30px;
            margin-top: 20px;
            margin-bottom: 20px;
            max-height: calc(100vh - 40px) !important;
            /* Важно для карты! */
            height: auto !important;
            right: 20px !important;
            overflow-y: auto !important;
        }
    }

    /* Typography & Colors */
    .t706__cartwin-heading,
    .t706__product-title,
    .t706__cartwin-prodamount-label,
    .t706__cartwin-totalamount-label,
    .t-input-title {
        font-family: 'Outfit', sans-serif !important;
        color: #1f2937 !important;
    }

    .t706__product-title {
        font-weight: 700 !important;
        font-size: 16px !important;
    }

    .t706__product-option-text {
        font-family: 'Inter', sans-serif !important;
        color: #666 !important;
    }

    /* Buttons (Orange) */
    .t706__cartwin-action .t706__submit-btn,
    .t706__cartwin-prodamount-btn {
        background: #ff7a00 !important;
        color: #fff !important;
        border-radius: 50px !important;
        font-family: 'Inter', sans-serif !important;
        font-weight: 700 !important;
        border: none !important;
        box-shadow: 0 4px 15px rgba(255, 122, 0, 0.25);
        transition: 0.3s;
    }

    .t706__cartwin-action .t706__submit-btn:hover {
        background: #e66e00 !important;
        box-shadow: 0 6px 20px rgba(255, 122, 0, 0.4);
        transform: translateY(-2px);
    }

    /* Inputs & Map Container */
    .t-input {
        background: #fff !important;
        border: 1px solid #eee !important;
        border-radius: 12px !important;
        padding-left: 15px !important;
        font-family: 'Inter', sans-serif !important;
        color: #333 !important;
        min-height: 50px;
    }

    .t-input:focus {
        border-color: #ff7a00 !important;
        box-shadow: 0 0 0 3px rgba(255, 122, 0, 0.1) !important;
    }

    /* Контейнер для карты доставки (восстановлен) */
    #dr-suggestion-container {
        z-index: 1000;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    /* Upsell Styles */
    .nova-upsell-wrap {
        padding: 20px 0;
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
    }

    .nova-upsell-title {
        font-family: 'Outfit';
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 12px;
        color: #444;
    }

    .nova-upsell-grid {
        display: flex;
        gap: 10px;
        overflow-x: auto;
        padding-bottom: 5px;
    }

    .nova-upsell-item {
        min-width: 70px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        text-align: center;
    }

    .nova-upsell-circle {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #f9fafb;
        border: 1px solid #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: 0.2s;
    }

    .nova-upsell-circle img {
        width: 40px;
        height: 40px;
        object-fit: contain;
    }

    .nova-upsell-item:hover .nova-upsell-circle {
        border-color: #ff7a00;
        background: #fff9f2;
    }

    .nova-upsell-name {
        font-size: 11px;
        font-family: 'Inter';
        color: #555;
        line-height: 1.2;
    }

    /* === HIDE NATIVE TILDA UPSELLS (REQUESTED) === */
    /* Ginger */
    .t-img-select__control:has([data-original*="tr.jpg"]),
    .t-img-select__control:has([style*="tr.jpg"]) {
        display: none !important;
    }

    /* Wasabi */
    .t-img-select__control:has([data-original*="was.jpg"]),
    .t-img-select__control:has([style*="was.jpg"]) {
        display: none !important;
    }

    /* Soy Sauce */
    .t-img-select__control:has([data-original*="sou.jpg"]),
    .t-img-select__control:has([style*="sou.jpg"]) {
        display: none !important;
    }

    /* Cutlery */
    .t-img-select__control:has([data-original*="grizly-cl.jpg"]),
    .t-img-select__control:has([style*="grizly-cl.jpg"]) {
        display: none !important;
    }

    /* === HIDE TEXT "Add additionally to order" === */
    #field-title_6812398569260 {
        display: none !important;
    }

    /* === HIDE LOCATION "Sataraohotnichya street" === */
    .t-radio__control:has(input[value^="Староохотничья улица, 4"]) {
        display: none !important;
    }

    /* === FIX: PRODUCT ADDED NOTIFICATION === */
    .t706__bubble {
        background: rgba(0, 0, 0, 0.9) !important;
        border-radius: 12px !important;
        padding: 15px 20px !important;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2) !important;
    }

    .t706__bubble-text,
    .t706__bubble-title,
    .t706__bubble-descr {
        color: #fff !important;
        font-family: 'Outfit', sans-serif !important;
    }
</style>

<script>
    /* === 2. DELIVERY MODULE CONFIGURATION (Bok 5 RESTORED) === */
    window.DELIVERY_MODULE_CONFIG = {
        "Название способа доставки": "Курьером",
        "Поля которые нужно скрывать при выборе доставки": ["delivery_address"],
        "Имя переменной для поля доставка": "delivery",
        "Имя переменой для вода адреса": "delivery_address",
        "Ссылка на Gist с зонами": "https://raw.githubusercontent.com/afilaga/yozhkin-roll/main/PRODUCTION/delivery_zones.json",

        "ТЕКСТА": {
            "Ошибка в модуле": "Техническая неполадка на сайте. Чтобы оформить доставку - пожалуйста обновите страницу. Если не помогло - свяжитесь с нами для оформления по телефону",
            "Неверные координаты": 'Не удалось определить Ваш адрес. Пожалуйста, позвоните нам для уточнения адреса доставки',
            "Неверный адрес": 'Неточный адрес, требуется указать дом',
            "Ошибка в блоке с сообщениями": 'Ошибка в поле адреса доставки',
            "Адрес не попадает в зону доставки": 'К сожалению, Ваш адрес не попадает в зону доставки',
            "Бесплатная доставка": 'Доставка по Вашему адресу бесплатная',
            "Сумма товаров меньше указанной для зоны доставки": 'Выберите товаров на сумму более чем {{MIN_DELIVERY_PRICE}-{CART_AMOUNT}} {CURRENCY_SYMBOL} для доставки по Вашему адресу',
            "Стоимость доставки": `Доставка по Вашему адресу стоит {DELIVERY_PRICE} {CURRENCY_SYMBOL}</br>Для бесплатной доставки, закажите продуктов еще на сумму {{FREE_DELIVERY_PRICE}-{CART_AMOUNT}} {CURRENCY_SYMBOL}`,
        },

        DaData: {
            params: {
                locations_geo: [{
                    lat: 43.550463,
                    lon: 39.843478,
                    radius_meters: 30000,
                }],
            },
        }
    };

    /* === 3. UPSELL LOGIC (ANTIDOTE & EXTRAS) === */
    // Helper function for safe addition
    window.addToCartUpsell = function (product) {
        console.log('Antigravity: Adding upsell product:', product);
        try {
            if (typeof tcart__addProduct === 'function') {
                tcart__addProduct(product);

                // Ensure data is saved to local storage immediately
                if (typeof tcart__saveLocalObj === 'function') tcart__saveLocalObj();

                // Force UI update
                setTimeout(function () {
                    // Recalculate totals
                    if (typeof tcart__updateTotal === 'function') tcart__updateTotal();

                    // Force redraw by calling openCart (standard Tilda way to render)
                    // This ensures the item appears immediately in the list
                    if (typeof tcart__openCart === 'function') {
                        tcart__openCart();
                    } else if (typeof tcart__reDrawCart === 'function') {
                        tcart__reDrawCart();
                    }
                }, 50);
            } else {
                console.error('Antigravity: tcart__addProduct is not a function');
                alert('Ошибка добавления: Корзина не инициализирована');
            }
        } catch (e) {
            console.error('Antigravity: Upsell Error:', e);
        }
    };

    document.addEventListener('DOMContentLoaded', function () {
        // Upsell Configuration
        const UPSELL_ITEMS = [
            {
                name: 'Имбирь',
                price: 50,
                img: 'https://optim.tildacdn.com/stor3434-3364-4365-b937-306362346135/-/resize/600x800/-/format/webp/b7f57a98abeaee47bc2f3a0df2048d15.jpg.webp',
                uid: '351561097752',
                url: 'https://yezhkin-roll.ru/menu/tproduct/351561097752-imbir'
            },
            {
                name: 'Васаби',
                price: 50,
                img: 'https://optim.tildacdn.com/stor3261-6239-4933-b365-303031646364/-/resize/600x800/-/format/webp/f82784e217c383422c98b4970ce93aff.png.webp',
                uid: '921582895132',
                url: 'https://yezhkin-roll.ru/menu/tproduct/921582895132-vasabi'
            },
            {
                name: 'Соевый соус',
                price: 60,
                img: 'https://optim.tildacdn.com/stor6239-6137-4034-b936-383135643165/-/resize/600x800/-/format/webp/3b57c15a2f75d9410121c219d1e117b3.jpg.webp',
                uid: '572601916672',
                url: 'https://yezhkin-roll.ru/menu/tproduct/572601916672-soevii-sous'
            }
        ];

        // Upsell Init
        const waitForCart = setInterval(() => {
            const cartContent = document.querySelector('.t706__cartwin-content');
            if (cartContent) {
                clearInterval(waitForCart);
                initNovaCart(cartContent);
            }
        }, 500);

        function initNovaCart(container) {
            // Check if already exists
            if (container.querySelector('.nova-upsell-wrap')) return;

            // Generate HTML
            const itemsHTML = UPSELL_ITEMS.map(item => `
                <div class="nova-upsell-item" onclick="addToCartUpsell({name:'${item.name}', price:${item.price}, img:'${item.img}', uid:'${item.uid}', url:'${item.url}'})">
                    <div class="nova-upsell-circle"><img src="${item.img}" alt="${item.name}"></div>
                    <span class="nova-upsell-name">${item.name}<br>${item.price}₽</span>
                </div>
            `).join('');

            const upsellContainer = document.createElement('div');
            upsellContainer.className = 'nova-upsell-wrap';
            upsellContainer.innerHTML = `
                <div class="nova-upsell-title">Добавить к заказу:</div>
                <div class="nova-upsell-grid">
                    ${itemsHTML}
                </div>
            `;

            const target = container.querySelector('.t706__cartwin-bottom');
            if (target) {
                target.parentNode.insertBefore(upsellContainer, target);
            }
        }
    });

    /* === 4. ANALYTICS FIX (OFFLINE PAYMENTS) === */
    window.t706_onSuccessCallback = function (form) {
        try {
            // 1. Get Payment Method
            // we want to ensure "purchase" is fired for everyone if Tilda doesn't do it for offline.

            // Yandex Metrica ID: 91003929
            const YM_ID = 91003929;
            const GOAL_ID = 'purchase';

            // Safely fire Metrica Goal
            if (typeof ym === 'function') {
                ym(YM_ID, 'reachGoal', GOAL_ID, {
                    order_id: form.querySelector('[name="tildapayment[orderid]"]')?.value || 'unknown',
                    revenue: form.querySelector('[name="tildapayment[amount]"]')?.value || 0
                });
                console.log('Antigravity: Manual Purchase Goal Fired');
            }
        } catch (e) {
            console.error('Antigravity Analytics Error:', e);
        }
    };
</script>